{% extends "base.html" %}
{% block title %}任务跟进{% endblock %}
{% block content %}
<div class="todohead">
    <div class="row" id="bugfilter">
        <ul class="nav nav-pills">
            <li role="presentation" role="button">项目版本
                <select id="version_filter"  class="bugfilter" >
                    <option value="all">全部</option>
                    <option value="syf1.1.1">syf1.1.1</option>
                    <option value="syf1.2.0">syf1.2.0</option>
                </select>
            </li>
            <li role="presentation" role="button">产品模块
                <select id="module_filter" class="bugfilter" >
                    <option value="all">全部</option>
                    <option value="Appointment">预约管理</option>
                    <option value="Preoperation">术前检查</option>
                    <option value="Evaluation">病理评估</option>
                    <option value="Timepoint">时点测评</option>
                    <option value="Report">报告采集</option>
                </select>

            </li>
            <li role="presentation" role="button">问题类型
                <select id="worktype_filter" class="bugfilter" >
                    <option value="all">全部</option>
                    <option value="requirement">需求</option>
                    <option value="bug">BUG</option>
                    <option value="changerequest">需求变更</option>
                </select>
            </li>
            
            <li role="presentation" class="dropdown">状态
                <select id="status_filter" class="bugfilter" >
                    <option value="all">全部</option>
                    <option value="Unresolved">未解决</option>
                    <option value="Completed">已完成</option>
                    <option value="Closed">已关闭</option>
                    <option value="Rejected">已拒绝</option>
                </select>
            </li>
            <li role="presentation" class="dropdown">创建日期
                <select id="createtime_filter" class="bugfilter" >
                    <option value="all">全部</option>
                    <option value="today">今日</option>
                    <option value="thisweek" selected = "selected">本周</option>
                    <option value="thismonth">本月</option>
                    <option value="thisyear">本年</option>
                </select>
            </li>

        </ul>    
    
        <div class="buttool">
            <button class="btn btn-success" data-toggle="modal" data-target="#addtodo">
                <i class="glyphicon glyphicon-plus"></i>添加</button>
            <button id="remove" class="btn btn-danger">
                <i class="glyphicon glyphicon-trash"></i> 删除
            </button>
        <!--<button class="btn btn-primary" data-table="todolist" aria-label="export type">导出</button>-->
    </div>
    
        <!-- Modal -->
        <div class="modal fade" id="addtodo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">

            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form class="form-inline" action="" method='POST'>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">任务添加</h4>
                    </div>
                    <div class="modal-body">

                            <div class="form-group">
                            <label for="project">项目名称</label>
                            <select class="form-control" id="project" name="project">
                               <option value="syf">邵逸夫项目</option>
                               <option value="datavue">DataVue项目</option>

                            </select>
                          </div>
                          <div class="form-group">
                            <label for="worktype">项目版本</label>
                            <select class="form-control" id="version" name="version">
                               <option value="syf1.1.1">syf1.1.1</option>
                               <option value="syf1.2.0">syf2.0.0</option>

                            </select>
                          </div>
                          <div class="form-group">
                            <label for="worktype">类型</label>
                            <select class="form-control" id="worktype" name="worktype">
                               <option value="requirement">需求</option>
                               <option value="changerequest">需求变更</option>
                               <option value="bug">BUG</option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="module">模块</label>

                            <select class="form-control" id="module" name="module">
                                <option value="Appointment">预约管理</option>
                                <option value="Preoperation">术前检查</option>
                                <option value="Evaluation">病理评估</option>
                                <option value="Timepoint">时点测评</option>
                                <option value="Report">报告采集</option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="title">标题</label>
                            <input type="text" class="form-control" id="title" name="title" style="width: 620px;" />
                          </div>
                          <div class="form-group">
                            <label for="description">描述</label>
                            <textarea  class="form-control" id="description" name="description" style="height: 130px;width:620px;"></textarea>
                          </div>
                          <div class="form-group">
                            <label for="developer">开发人员</label>

                            <select  class="form-control multiple" id="developer" name="developer[]" multiple="true">
                                <option value=1>张路</option>
                                <option value=2>李小满</option>
                                <option value=3>徐郁</option>
                                <option value=4>陈梦梦</option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="tester">测试人员</label>
                            <select  class="form-control multiple" id="tester" name="tester[]" multiple="multiple">
                                <option value=1>高文琪</option>
                                <option value=2>俞利芳</option>
                                <option value=3>王健</option>

                            </select>
                          </div>
                          <div class="form-group">
                            <label for="status">状态</label>
                            <select class="form-control" id="status" name="status">
                                <option value="Unresolved">未解决</option>
                                <option value="Completed">已完成</option>
                                <option value="Closed">已关闭</option>
                                <option value="Rejected">已拒绝</option>

                            </select>
                          </div>
                          <div class="form-group">
                            <label for="createtime">创建日期</label>
                            <input type="Date" id="createtime"  name="createtime" class="form-control" />
                          </div>
                          <div class="form-group">
                            <label for="completetime">完成日期</label>
                            <input type="Date" id="completetime" name="completetime" class="form-control" />
                          </div>
                          <div class="form-group">
                            <label for="remarks">备注</label>
                            <textarea  class="form-control" id="remarks" name="remarks" style="width: 620px;"></textarea>
                          </div>

                            <!--<button  type="submit" class="btn btn-default">Submit &nbsp</button>-->



                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="add_todo">保存</button>
                    </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<div>
    <table id="todolist" class="table table-hover">
    </table>
    <script type="text/javascript">
        $(document).ready(function () {
            // 初始化table
            initTable();
            setworkType();
//
//            if(localStorage.getItem("username")!="admin"){//权限控制
//                $("#remove").remove();
//            }
            //下拉多选
            $('.multiple').selectpicker();



        })

        function initTable(){

            $('#todolist').bootstrapTable('destroy');  //先销毁表格

            $('#todolist').bootstrapTable({
                url:'/query_todo',
                method:'get',
//                contentType : "application/x-www-form-urlencoded",
                toolbar:'#toolbar',
                dataType:'json',
                striped:false,  //是否行间隔色显示
                cache:false,//是否试用缓存，默认为true
                pagination:true, //s是否分页
                sortable:true,  //是否启用排序
                sortOrder:"ID asc", // 排序方式
                pageNumber:1, //初始化加载第一页，默认第一页
                pageSize:20 , //每页的记录行数
                pageList:[10,20,50] ,  //可供选择的每页行数
                queryParamsType:'limit', //默认为limit， 在默认情况下，传给服务器的参数为；offset，limit， 设置为''则传给服务器的参数为pageSize，pageNumber
                queryParams: queryParams,
                sidePagination:"server",// 分页方式，client为客户端分页，server为服务端分页
                strictSearch:true,
                clickToSelect:true,  //是否启动点击选中行
                search:false,

                columns:[
                    
                            {   
                                title:"",
                                field:'state',
                                checkbox:true,
                                align:'center',
                                valign:'middle'
                            },
                            {
                                title:'ID',
                                field:'id',
                                align:'left',
                                valign:'middle',
                                width:35,
                                sortable:true,
                                class:'text-overflow'                           
                            },{
                                title:'Version',
                                field:'version',
                                align:'left',
                                valign:'middle',
                                class:'text-overflow',
                                switchable:true
                            },{
                                title:'WorkType',
                                field:'worktype',
                                align:'left',
                                valign:'middle',
                                class:'text-overflow',
                                editable: {
                                    type: 'select',
                                    title: '模块',
                                    mode: "popup",
                                    emptytext: "--",
                                    source:[{value:"requirement",text:"需求"},
                                        {value:"changerequest",text:"需求变更"},
                                        {value:"bug",text:"BUG"}],
                                    validate: function (v) {
                                        if (!v) return '任务类型不能为空';

                                    },
                                    url:'/edit_todo',
                                    success: function(response, newValue) {
                                        if(newValue=='bug'){
                                            $(this).addClass("redBackground");
                                        }
                                        else {
                                            $(this).removeClass("redBackground");
                                        }

                                        if(response.status =='error') {
                                            return response.msg;
                                        }
                                    }
                                },
                                switchable:true


                            },{
                                title:'Module',
                                field:'module',
                                align:'center',
                                valign:'middle',
                                sortable:true,
                                editable: {
                                    type: 'select',
                                    title: '模块',
                                    mode: "popup",
                                    emptytext: "--",
                                    source:[{value:"Appointment",text:"预约管理"},
                                        {value:"Preoperation",text:"术前检查"},
                                        {value:"Evaluation",text:"病理评估"},
                                        {value:"Timepoint",text:"时点测评"},
                                        {value:"Report",text:"报告采集"}],
                                    validate: function (v) {
                                        if (!v) return '任务类型不能为空';

                                    },
                                    url:'/edit_todo',
                                    success: function(response, newValue) {

                                        if(response.status =='error') {
                                            return response.msg;
                                        }
                                    }
                                },
                                switchable:true
                            },{
                                title:'Title',
                                field:'title',
                                width:200,
                                align:'left',
                                valign:'middle',
                                editable: {
                                    type: 'text',
                                    title: '标题',
                                    mode: "popup",
                                    emptytext: "--",
                                    validate: function (v) {
                                        if (!v) return '标题不能为空';
                                    },
                                    url:'/edit_todo',
                                    success: function(response, newValue) {
                                        if(response.status =='error') {
                                            return response.msg;
                                        }
                                    }
                                },
                                width:200,
                                sortable:true
                            },{
                                title:'Description',
                                field:'description',
                                align:'left',
                                valign:'middle',
                                width:480,
                                editable: {
                                    type: 'textarea',
                                    title: '描述',
                                    mode: "popup",
                                    emptytext: "--",
                                    url:'/edit_todo',
                                    success: function(response, newValue) {
                                        if(response.status =='error') {
                                            return response.msg;
                                        }
                                    }
                                }   
                            },{
                                title:'Developer',
                                field:'developer',
                                align:'center',
                                valign:'middle',

                                editable:{
                                    type: 'checklist',
                                    pk:'1',
                                    separator:",",
                                    value:"' + row[that.options.idField] + '",
                                    title: '开发人员',
                                    mode: "inline",
                                    emptytext: "--",
                                    source:[{value:1,text:"张路"},
                                            {value:2,text:"李小满"},
                                            {value:3,text:"徐郁"},
                                            {value:4,text:"陈梦梦"}],
                                    url:'/edit_todo',
                                    success: function(response, newValue) {
                                        if(response.status =='error') {
                                            return response.msg;
                                        }
                                    }
                                }
                            },{
                                title:'Tester',
                                field:'tester',
                                align:'center',
                                valign:'middle',
                                switchable:false,
                                editable: {
                                    type: 'checklist',
                                    separator:",",
                                    title: '测试人员',
                                    emptytext: "--",
                                    mode: "popup",
                                    source:[{value:1,text:"高文琪"},{value:2,text:"俞利芳"},{value:3,text:"王健"}],
                                    url:'/edit_todo',
                                    success: function(response, newValue) {
                                        if(response.status =='error') {
                                           return response.msg;
                                        }
                                    }
                                },
                                sortable:true
                            },{
                                title:'Status',
                                field:'status',
                                align:'center',
                                valign:'middle',
                                editable: {
                                    type: 'select',
                                    title: '状态',
                                    emptytext: "--",
                                    mode: "popup",
                                    source:[
                                            {value: 'Unresolved', text: '未解决'},
                                            {value: 'Completed', text: '已完成'},
                                            {value: 'Rejected', text: '已拒绝'},
                                            {value: 'Closed', text: '已关闭'}],
                                    url:'/edit_todo',
                                    pk:6,
                                    success: function(response, newValue) {
                                        if(newValue=='Unresolved'){     //控制颜色显示
                                            $(this).addClass("redBackground");
                                        }
                                        else {
                                            $(this).removeClass("redBackground");
                                        }
                                        if(response.status =='error') {
                                            return response.msg;
                                        }
                                    }
                                },
                                sortable:true
                            },{
                                title:'备注',
                                field:'remarks',
                                align:'center',
                                valign:'middle',
                                editable: {
                                    type: 'textarea',
                                    title: '描述',
                                    emptytext: "--",
                                    mode: "popup",
                                    url:'/edit_todo',
                                    pk:6,
                                    success: function(response, newValue) {
                                        if(response.status =='error') {
                                            return response.msg;
                                        }
                                    }
                                },
                                sortable:true
                            },{
                                title:"CreateTime",
                                field:"createtime",
                                sortable:true,
                                align:'center',
                            }
                        ],
                showColumns:true,   // 是否显示列
                minimumCountColumns:2,
                showRefresh:true,  // 是否刷新
                showToggle:true,
                showExport:true,
                exportDataType: "selected",   //basic', 'all', 'selected'.
                exportTypes:['excel'],
                formatLoadingMessage: function () {
                    return
                },


            });
            };
        function queryParams(params) {  //配置参数
            var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                limit: params.limit,   //每页的个数
                offset: params.offset,  //分页时数据偏移量
                sort: params.sort,  //排序列名
                order: params.order,//排位命令（desc，asc）
                version: $("#version_filter").val(),
                module: $("#module_filter").val(),
                worktype: $("#worktype_filter").val(),
                status: $("#status_filter").val(),
                createtime:$("#createtime_filter").val()
            };
            return temp;
        };
        var setworkType = function ()  {
            try{
                var d = $("#todolist").html().replace("BUG", "<span class='workType typeBug'>BUG</span>");
                    d = d.replace("需求", "<div class='workType typeRe'>需求</div>");
                    d = d.replace("需求变更", "<div class='workType typeChange'>需求变更</div>");

                    $("#todolist").html(d);
            }catch (msg)
            {alert (msg)}

        };

        function getIdSelections() {
            return $.map($("#todolist").bootstrapTable('getSelections'), function (row) {
            return row.id
        });
        };
        $(".bugfilter").change(function(){
            $('#todolist').bootstrapTable('refresh',{url: '/query_todo'});
        });

        // 监听模态框事件
        $(function () { $('#addtodo').on('shown.bs.modal', function () {
            var d = new Date().Format("yyyy-MM-dd");  //获取当前日期并格式化
            $('#createtime').val(d);
          })

        });

        //添加todo操作
        $("#add_todo").click(function () {
            if ($("#title").val().trim() == "") {
                $("#title").focus();
                alert("请输入必填项！");
                return false;
            }
            postdata ={
                "project":$('#project').val(),
                "version":$('#version').val(),
                "worktype":$('#worktype').val(),
                "module":$('#module').val(),
                "title":$('#title').val(),
                "description":$('#description').val(),
                "developer":$('#developer').val(),
                "tester":$('#tester').val(),
                "status":$('#status').val(),
                "createtime":$('#createtime').val(),
                "completetime":$('#completetime').val(),
                "remarks":$('#remarks').val()
            };
            $.ajax({
                //提交数据的类型 POST GET
                type:"POST",
                //提交的网址
                url:"/add_todo",
                //提交的数据
                data:postdata,
                //返回数据的格式 "xml", "html", "script", "json", "jsonp", "text"
//                datatype: "json",
                //ajax请求成功后的事件
                    success:function(){

                    alert("保存成功！");
                    $('.modal').modal('hide');
                    location.reload();
                    // $('#tosolist').html($(data).find('#todolist').html());
                    <!--onchange();-->
                    },
                    error: function(e){
                    //请求出错处理
                    alert(e);
                },
            });
        });
        //删除操作
        $("#remove").click(function () {
            var ids = getIdSelections();
            if (ids.length < 1) {
                alert("请选中要删除的行！");
                return;
            }
            if (confirm("确定删除选中行吗？")) {
                $.ajax({
                    type: "post",
                    url: "/delete_todo",
                    data:{"ids":ids},
                        success:function(){
                            alert("删除成功！");
                            location.reload();
                        },
                        error:function(e){
                            alert(e);
                            console.error(e);
                        }
                    });
            }
        });

    // 对Date的扩展，将 Date 转化为指定格式的String
    // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
    // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
    // 例子：
    // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
    // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }
    </script>
</div>

{% endblock %}